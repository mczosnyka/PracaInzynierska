{% extends "layout.html" %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
    #map { height: 500px; width: 100%; border-radius: 5px; border: 1px solid #ccc; margin-bottom: 20px; cursor: crosshair; }
    .panel-container { display: flex; gap: 20px; }
    .left-panel { flex: 2; }
    .right-panel { flex: 1; }
    .points-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
    .points-table th { background-color: #34495e; color: white; padding: 8px; text-align: left; }
    .points-table td { border-bottom: 1px solid #eee; padding: 8px; }
    .badge-hub { background-color: #8e44ad; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.8em; }
    .badge-delivery { background-color: #2980b9; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.8em; }
    .alert-box { padding: 10px; margin-bottom: 15px; color: white; border-radius: 4px; font-weight: bold; }
    .alert-success { background-color: #27ae60; }
    .alert-error { background-color: #c0392b; }
    .popup-form input, .popup-form select { width: 100%; margin-bottom: 5px; padding: 5px; box-sizing: border-box; }
    .popup-form button { width: 100%; background-color: #27ae60; color: white; border: none; padding: 8px; cursor: pointer; }
    .vehicle-row { margin-bottom: 8px; padding: 5px; border-radius: 4px; border: 1px solid transparent; }
    .seq-icon { background: white; border: 2px solid #333; border-radius: 50%; text-align: center; font-weight: bold; line-height: 24px; font-family: Arial, sans-serif; }
</style>
{% endblock %}

{% block content %}

{% set points_list = [] %}{% for p in zlecenie.punkty %}{% set _ = points_list.append(p.to_dict()) %}{% endfor %}
<script id="points-data-json" type="application/json">{{ points_list | tojson | safe }}</script>

{% set routes_list = [] %}
{% if zlecenie.status == 'zakonczone' %}
    {% for t in zlecenie.wygenerowane_trasy %}
        {% set _ = routes_list.append({'pojazd_id': t.id_pojazdu, 'numer': t.pojazd.numer_rejestracyjny, 'dystans': t.dlugosc, 'czas': t.czas_przejazdu, 'geometry': t.geometria_trasy, 'points_order': t.szczegoly_punktow}) %}
    {% endfor %}
{% endif %}
<script id="routes-data-json" type="application/json">{{ routes_list | tojson | safe }}</script>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert-box {{ 'alert-success' if category=='success' else 'alert-error' }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <div>
        <a href="{{ url_for('zlecenia') }}" style="text-decoration: none; color: #7f8c8d;">‚Üê Powr√≥t</a>
        <h2 style="margin: 5px 0;">Zlecenie: {{ zlecenie.nazwa }}</h2>
    </div>
    {% if zlecenie.status != 'zakonczone' %}
        <form action="{{ url_for('optymalizuj_zlecenie', id_zlecenia=zlecenie.id) }}" method="POST">
            <button type="submit" style="background-color: #2c3e50; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">‚öôÔ∏è Optymalizuj</button>
        </form>
    {% endif %}
</div>

<div class="panel-container">
    <div class="left-panel card">
        <h4>Mapa Operacyjna</h4>
        <div id="map" data-locked="{{ 'true' if zlecenie.status == 'zakonczone' else 'false' }}"></div>
    </div>

    <div class="right-panel card">
        <h4 style="margin-top: 0;">Punkty ({{ zlecenie.punkty|length }})</h4>
        <table class="points-table">
            <thead><tr><th>Nazwa</th><th>Typ</th><th></th></tr></thead>
            <tbody>
                {% for p in zlecenie.punkty %}
                <tr>
                    <td>{{ p.nazwa }}</td>
                    <td><span class="{{ 'badge-hub' if p.typ == 'HUB' else 'badge-delivery' }}">{{ p.typ }}</span></td>
                    <td style="text-align: right;">
                        {% if zlecenie.status != 'zakonczone' %}
                            <button type="button" onclick="handleDeletePoint('{{ p.id }}', '{{ p.nazwa }}')" style="background: none; border: none; cursor: pointer; color: red;">üóëÔ∏è</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
            <h4>üöõ Flota</h4>
            <form action="{{ url_for('przypisz_pojazdy', id_zlecenia=zlecenie.id) }}" method="POST">
                {% set przypisane_ids = zlecenie.dostepne_pojazdy | map(attribute='id_pojazdu') | list %}
                {% for pojazd in moje_pojazdy %}
                <div class="vehicle-row">
                    <label>
                        <input type="checkbox" name="pojazdy_ids" value="{{ pojazd.id_pojazdu }}" 
                            {% if pojazd.id_pojazdu in przypisane_ids %}checked{% endif %}
                            {% if (not pojazd.dostepnosc and pojazd.id_pojazdu not in przypisane_ids) or zlecenie.status == 'zakonczone' %}disabled{% endif %}>
                        {{ pojazd.numer_rejestracyjny }} ({{ pojazd.pojemnosc }}kg)
                    </label>
                </div>
                {% endfor %}
                {% if zlecenie.status != 'zakonczone' %}
                    <button type="submit" style="width: 100%; background-color: #f39c12; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer;">Zapisz Flotƒô</button>
                {% endif %}
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([50.06, 19.93], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const pointsData = JSON.parse(document.getElementById('points-data-json').textContent);
    pointsData.forEach(p => {
        let color = (p.typ === 'HUB') ? 'purple' : '#3498db';
        L.circleMarker([p.lat, p.lon], { color: color, radius: 6 }).addTo(map).bindPopup(p.nazwa);
    });

    if (pointsData.length > 0) {
        const group = new L.featureGroup(pointsData.map(p => L.marker([p.lat, p.lon])));
        map.fitBounds(group.getBounds().pad(0.1));
    }

    map.on('click', function(e) {
        if (document.getElementById('map').dataset.locked === 'true') return;
        const lat = e.latlng.lat.toFixed(5), lon = e.latlng.lng.toFixed(5);
const form = `
<div class="popup-form">
    <form action="{{ url_for('dodaj_punkt', id_zlecenia=zlecenie.id) }}" method="POST">
        <input type="hidden" name="lat" value="${lat}">
        <input type="hidden" name="lon" value="${lon}">
        
        <label>Nazwa:</label>
        <input type="text" name="nazwa" required placeholder="np. Sklep ABC">
        
        <label>Typ:</label>
        <select name="typ">
            <option value="DELIVERY">Klient</option>
            <option value="HUB">Magazyn</option>
        </select>
        
        <label>Waga (kg):</label>
        <input type="number" name="waga" value="0">
        
        <div style="display: flex; gap: 5px;">
            <div>
                <label>Od:</label>
                <input type="time" name="okno_od" value="08:00">
            </div>
            <div>
                <label>Do:</label>
                <input type="time" name="okno_do" value="16:00">
            </div>
        </div>
        
        <button type="submit" style="margin-top: 10px;">Dodaj Punkt</button>
    </form>
</div>`;
        L.popup().setLatLng(e.latlng).setContent(form).openOn(map);
    });

    function handleDeletePoint(id, name) {
        if (confirm(`Czy usunƒÖƒá punkt ${name}?`)) {
            fetch(`/zlecenia/usun_punkt/${id}`, { method: 'DELETE' })
            .then(res => { if (res.ok) window.location.reload(); });
        }
    }
</script>
{% endblock %}